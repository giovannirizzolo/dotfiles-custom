#!/usr/bin/env bash
# tmux "IDE" layout with built-in layouts and fixed main pane sizes
# Usage: ide [h|v]   (h = big top; v = big left)
set -euo pipefail

# ==== TUNE HERE =====================================================
MAIN_PCT_H=70 # % of window height for the big TOP pane in horizontal mode
MAIN_PCT_V=70 # % of window width  for the big LEFT pane in vertical mode
# ===================================================================

usage() {
  echo "Usage: $(basename "$0") [h|v]"
  exit 1
}
[[ $# -eq 1 ]] || usage
mode="$(printf '%s' "$1" | tr '[:upper:]' '[:lower:]')"
[[ "$mode" = h || "$mode" = v ]] || usage

command -v tmux >/dev/null || {
  echo "tmux not found" >&2
  exit 127
}

# create window (inside or outside tmux)
if [[ -n "${TMUX:-}" ]]; then
  win_id="$(tmux new-window -n "quad-${mode}" -P -F '#{window_id}')" # @X
  tmux select-window -t "$win_id"
else
  sess="layout-${mode}"
  tmux new-session -d -s "$sess" -n "quad-${mode}"
  win_id="$(tmux display-message -p -t "${sess}:1" '#{window_id}')" # @X
fi

# Build 4 panes quickly (no percentages â†’ robust on small terminals)
tmux split-window -t "$win_id" -h
tmux split-window -t "$win_id" -v
tmux split-window -t "$win_id" -v

# Compute absolute size for the main pane from window dimensions
win_w=$(tmux display-message -p -t "$win_id" '#{window_width}')
win_h=$(tmux display-message -p -t "$win_id" '#{window_height}')

clamp() { # clamp value to [min,max]
  local v="$1" min="$2" max="$3"
  ((v < min)) && v="$min"
  ((v > max)) && v="$max"
  printf '%d' "$v"
}

if [[ "$mode" = h ]]; then
  main_h=$((win_h * MAIN_PCT_H / 100))
  main_h=$(clamp "$main_h" 5 "$((win_h - 3))") # avoid too-small panes
  tmux setw -t "$win_id" main-pane-height "$main_h"
  tmux select-layout -t "$win_id" main-horizontal # big top
else
  main_w=$((win_w * MAIN_PCT_V / 100))
  main_w=$(clamp "$main_w" 10 "$((win_w - 5))")
  tmux setw -t "$win_id" main-pane-width "$main_w"
  tmux select-layout -t "$win_id" main-vertical # big left
fi

tmux select-pane -t "$win_id".0

# attach if we started tmux
if [[ -z "${TMUX:-}" ]]; then
  sess_and_win="$(tmux display-message -p -t "$win_id" '#{session_name}:#{window_index}')"
  exec tmux attach -t "$sess_and_win"
fi
