#!/usr/bin/env bash
# Portable zsh + tmux layout helper
# Usage: ide [h|v]
if command -v fish >/dev/null 2>&1; then
  SHELL="$(command -v fish)"
if command -v zsh >/dev/null 2>&1; then
  SHELL="$(command -v zsh)"
if command -v bash >/dev/null 2>&1; then
  SHELL="$(command -v bash)"
export SHELL

prog=${SHELL:-${${(%):-%N}:t}}

set -euo pipefail

usage (){
  echo "Usage: $prog [h|v]"
  echo "  h = horizontal: big top + 3 panes along the bottom"
  echo "  v = vertical: big left + 3 panes stacked on the right"
  exit 1
}

require_cmd(){
  command -v "$1" >/dev/null 2>&1 || {
    echo "Error: '$1' not found. Please install it and try again." >&2
    case "$1" in
      tmux)
        if command -v brew >/dev/null 2>&1; then
          echo "  macOS: brew install tmux" >&2
        elif command -v apt-get >/dev/null 2>&1; then
          echo "  Debian/Ubuntu/WSL: sudo apt-get update && sudo apt-get install -y tmux" >&2
        elif command -v dnf >/dev/null 2>&1; then
          echo "  Fedora: sudo dnf install -y tmux" >&2
        fi
        ;;
    esac
    exit 127
  }
}

# ---- parse args
[[ $# -eq 1 ]] || usage
mode="${1:l}"                # zsh: to lowercase
[[ "$mode" == "h" || "$mode" == "v" ]] || usage

# ---- env checks
require_cmd tmux
if [[ -z "${TMUX:-}" ]] && [[ ! -t 1 ]]; then
  echo "Warning: stdout is not a TTY; running tmux might fail in non-interactive context." >&2
fi

make_horizontal_layout(){
  local target="$1"
  tmux select-window -t "$target"
  tmux split-window -t "$target" -v -p 30
  tmux split-window -t "$target" -h -p 66
  tmux split-window -t "$target" -h -p 50
  tmux select-pane -t "$target".0
}

make_vertical_layout(){
  local target="$1"
  tmux select-window -t "$target"
  tmux split-window -t "$target" -h -p 30
  tmux split-window -t "$target" -v -p 66
  tmux split-window -t "$target" -v -p 50
  tmux select-pane -t "$target".0
}

# ---- create target window (works inside/outside tmux)
if [[ -n "${TMUX:-}" ]]; then
  target="$(tmux new-window -n "quad-${mode}" -P -F '#{session_name}:#{window_index}')"
else
  sess="layout-${mode}"
  tmux new-session -d -s "$sess" -n "quad-${mode}"
  target="${sess}:1"
fi

# ---- build layout
if [[ "$mode" == "h" ]]; then
  make_horizontal_layout "$target"
else
  make_vertical_layout "$target"
fi

# ---- attach if we created a new session
if [[ -z "${TMUX:-}" ]]; then
  tmux attach -t "$target"
fi
